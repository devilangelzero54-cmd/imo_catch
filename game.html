<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚ã„ã£ç‹ã®ãŠèŠ‹ã‚­ãƒ£ãƒƒãƒ - ã‚²ãƒ¼ãƒ </title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #000;
      font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      overflow: hidden;
    }

    .game-wrap {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
      color: #fff;
    }

    /* èƒŒæ™¯ï¼šæ¨ªå¹…100%ã§ä¸Šä¸‹ã¯é»’å¸¯ã«ãªã‚‹æƒ³å®š */
    .bg-game {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 100vw;
      height: auto;
      z-index: 0;
      pointer-events: none;
    }

    /* ä¸Šã®ã‚¹ã‚³ã‚¢ãƒ»ã‚¿ã‚¤ãƒ å¸¯ */
    .hud {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 8px 14px;
      background: #000;
      color: #fff;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      z-index: 5;
    }
    .hud span {
      letter-spacing: 0.15rem;
    }

    /* è½ã¡ã¦ãã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ */
    .fall-item {
      position: absolute;
      width: 8vh;
      max-width: 80px;
      z-index: 3;
      pointer-events: none;
      user-select: none;
      touch-action: none;
    }

    /* ã‚­ãƒ£ãƒ© */
    .character {
      position: absolute;
      bottom: 16%;        /* èƒŒæ™¯ã®ä¸­ã§å°‘ã—ä¸Šã«æµ®ã‹ã›ã‚‹ */
      left: 50%;
      transform: translateX(-50%);
      height: 28vh;
      width: autovh;        /* ã‚²ãƒ¼ãƒ ç”¨ã¯ã‚¿ã‚¤ãƒˆãƒ«ã‚ˆã‚Šå°ã•ã‚ */
      max-width: 230px;
      z-index: 4;
      pointer-events: none;
      user-select: none;
      touch-action: none;
    }

    /* å·¦å³ãƒœã‚¿ãƒ³ */
    .ctrl-btn {
      position: absolute;
      bottom: 10%;
      width: 64px;
      height: 48px;
      border-radius: 12px;
      border: none;
      background: rgba(0, 0, 0, 0.55);
      color: #fff;
      font-size: 1.6rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 6;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }
    .ctrl-btn.left {
      left: 6%;
    }
    .ctrl-btn.right {
      right: 6%;
    }
    .ctrl-btn:active {
      background: rgba(255, 131, 183, 0.85);
    }

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚³ã‚¢ */
    .popup {
      position: absolute;
      color: #fff;
      font-weight: 700;
      font-size: 1.1rem;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
      z-index: 7;
      pointer-events: none;
      animation: popFade 0.6s ease-out forwards;
    }
    @keyframes popFade {
      0%   { transform: translateY(0);   opacity: 1; }
      100% { transform: translateY(-20px); opacity: 0; }
    }

    /* çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .result-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .result-card {
      background: rgba(20, 20, 20, 0.9);
      padding: 16px 16px 20px;
      border-radius: 16px;
      text-align: center;
      max-width: 90vw;
    }
    .result-card img {
      width: 80vw;
      max-width: 320px;
      border-radius: 12px;
      display: block;
      margin: 0 auto 12px;
    }
    .result-score {
      font-size: 1.3rem;
      margin-bottom: 10px;
    }
    .result-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .result-buttons button {
      flex: 1;
      min-width: 120px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-retry {
      background: #ff83b7;
      color: #fff;
    }
    .btn-title {
      background: #fff;
      color: #333;
    }
    
    /* ã‚­ãƒ£ãƒ©åè»¢ç”¨ã‚¯ãƒ©ã‚¹ */
.flipH {
  transform: translateX(-50%) scaleX(-1);
}
  </style>
</head>
<body>
  <div class="game-wrap" id="gameWrap">
    <!-- èƒŒæ™¯ -->
    <img src="images/game_bg.png" alt="èƒŒæ™¯" class="bg-game" />

    <!-- HUD -->
    <div class="hud">
      <span id="scoreText">score 0000</span>
      <span id="timeText">æ®‹ã‚Šæ™‚é–“ 30</span>
    </div>

    <!-- ã‚­ãƒ£ãƒ© -->
    <img
      id="character"
      src="images/normal.png"
      alt="ã‚ã„ã£ç‹"
      class="character"
    />

    <!-- å·¦å³ç§»å‹•ãƒœã‚¿ãƒ³ -->
    <button class="ctrl-btn left" id="btnLeft">&lt;</button>
    <button class="ctrl-btn right" id="btnRight">&gt;</button>

    <!-- çµæœç”»é¢ -->
    <div class="result-overlay" id="resultOverlay">
      <div class="result-card">
        <img src="images/clear_bg.png" alt="ã‚¯ãƒªã‚¢ç”»åƒ" />
        <div class="result-score" id="resultScore">score 0000</div>
        <div class="result-buttons">
          <button class="btn-retry" id="btnRetry">ğŸ ãŠã‹ã‚ã‚Šâ™ª</button>
          <button class="btn-title" id="btnTitle">ãŸã„ã¨ã‚‹ã¸â™ª</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**********************************************
     * åŸºæœ¬è¨­å®šï¼ˆã“ã“ã‚’ã„ã˜ã‚Œã°èª¿æ•´ã—ã‚„ã™ã„ã‚¾ãƒ¼ãƒ³ï¼‰
     **********************************************/
    const GAME_TIME = 30;                 // åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰
    const CHAR_SPEED = 280;              // ã‚­ãƒ£ãƒ©ã®ç§»å‹•é€Ÿåº¦(px / ç§’)

    const SCORE_NORMAL = 10;             // é€šå¸¸èŠ‹
    const SCORE_GOLD = 50;               // é‡‘èŠ‹
    const SCORE_LEAF = -10;              // è½ã¡è‘‰ãƒœãƒ¼ãƒ«

    const STUN_DURATION = 600;           // ãƒ’ãƒƒãƒˆæ™‚ã®ç¡¬ç›´(ms)

    const IMG_CHAR_NORMAL = "images/normal.png";
    const IMG_CHAR_HIT = "images/surprised_bad.png";

    const IMG_IMO_NORMAL = "images/imo_normal.png";
    const IMG_IMO_GOLD = "images/imo_gold.png";
    const IMG_LEAF = "images/leaf_bad.png";

    /**********************************************
     * DOMå–å¾—
     **********************************************/
    const gameWrap = document.getElementById("gameWrap");
    const charImg = document.getElementById("character");
    const scoreText = document.getElementById("scoreText");
    const timeText = document.getElementById("timeText");
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");
    const resultOverlay = document.getElementById("resultOverlay");
    const resultScore = document.getElementById("resultScore");
    const btnRetry = document.getElementById("btnRetry");
    const btnTitle = document.getElementById("btnTitle");

    /**********************************************
     * çŠ¶æ…‹ç®¡ç†
     **********************************************/
    let gameStarted = false;
    let gameOver = false;

    let score = 0;
    let remainingTime = GAME_TIME;
    let lastTime = null;

    let moveDir = 0;             // -1: å·¦ / 1: å³ / 0: åœæ­¢
    let isStunned = false;
    let stunTimeoutId = null;

    let charX;                   // ç”»é¢ä¸Šã®ã‚­ãƒ£ãƒ©ä¸­å¿ƒX(px)

    let spawnTimer = 0;          // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‡ºç¾ã¾ã§ã®æ®‹ã‚Šæ™‚é–“(ms)
    const objects = [];          // {el, x, y, vy, type}

    /**********************************************
     * ä¾¿åˆ©é–¢æ•°
     **********************************************/
    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    function updateHud() {
      const s = String(score).padStart(4, "0");
      scoreText.textContent = `score ${s}`;
      timeText.textContent = `æ®‹ã‚Šæ™‚é–“ ${Math.ceil(remainingTime)}`;
    }

    function createPopup(x, y, text) {
      const div = document.createElement("div");
      div.className = "popup";
      div.textContent = text;
      div.style.left = x + "px";
      div.style.top = y + "px";
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 650);
    }

    function getCharBounds() {
      const rect = charImg.getBoundingClientRect();
      // ã‚«ã‚´ã®ã‚ãŸã‚Šã ã‘å°‘ã—ç‹­ã‚ã¦ä½¿ã†
      const width = rect.width;
      const height = rect.height;
      const basketTop = rect.top + height * 0.4;
      const basketBottom = rect.bottom - height * 0.05;
      const basketLeft = rect.left + width * 0.15;
      const basketRight = rect.right;
      return {
        top: basketTop,
        bottom: basketBottom,
        left: basketLeft,
        right: basketRight,
      };
    }

    /**********************************************
     * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‡ºç¾
     **********************************************/
    function spawnObject(deltaMs) {
      if (spawnTimer > 0) {
        spawnTimer -= deltaMs;
        return;
      }

      // çµŒéæ™‚é–“ã§é›£æ˜“åº¦ã‚’å¤‰ãˆã‚‹
      const elapsed = GAME_TIME - remainingTime;

      // è½ä¸‹é€Ÿåº¦(px/s)
      let vy;
      // å‡ºç¾é–“éš”(ms)
      let nextInterval;
      // ç¨®é¡
      let type;

      if (elapsed < 10) {
        // åºç›¤ï¼šé€šå¸¸èŠ‹ã®ã¿
        type = "normal";
        vy = 110 + Math.random() * 40;      // 110ã€œ150
        nextInterval = 900 + Math.random() * 300; // 0.9ã€œ1.2ç§’
      } else if (elapsed < 20) {
        // ä¸­ç›¤ï¼šé€šå¸¸ï¼‹é‡‘èŠ‹
        const r = Math.random();
        if (r < 0.25) {
          type = "gold";
        } else {
          type = "normal";
        }
        vy = 130 + Math.random() * 60;      // 130ã€œ190
        nextInterval = 800 + Math.random() * 250;
      } else {
        // çµ‚ç›¤ï¼šé€šå¸¸ï¼‹é‡‘èŠ‹ï¼‹è½ã¡è‘‰ãƒœãƒ¼ãƒ«
        const r = Math.random();
        if (r < 0.25) {
          type = "gold";
        } else if (r < 0.5) {
          type = "leaf";
        } else {
          type = "normal";
        }
        vy = 160 + Math.random() * 90;      // 160ã€œ250
        nextInterval = 650 + Math.random() * 220;
      }

      // DOMè¦ç´ ä½œæˆ
      const el = document.createElement("img");
      el.className = "fall-item";
      if (type === "normal") {
        el.src = IMG_IMO_NORMAL;
      } else if (type === "gold") {
        el.src = IMG_IMO_GOLD;
      } else {
        el.src = IMG_LEAF;
      }

      // ç”»é¢æ¨ªå¹…ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãªX
      const w = window.innerWidth;
      const margin = 20;
      const x = margin + Math.random() * (w - margin * 2);
      const y = -80;

      el.style.left = x + "px";
      el.style.top = y + "px";

      document.body.appendChild(el);

      objects.push({ el, x, y, vy, type });
      spawnTimer = nextInterval;
    }

    /**********************************************
     * ã‚­ãƒ£ãƒ©ç§»å‹•
     **********************************************/
    function updateCharacter(dt) {
      if (!gameStarted || gameOver) return;

      const rect = charImg.getBoundingClientRect();
      const charWidth = rect.width || 200;
      const margin = 0;
      const minX = margin + charWidth / 2;
      const maxX = window.innerWidth - margin - charWidth / 2;

      if (!isStunned && moveDir !== 0) {
        charX += moveDir * CHAR_SPEED * dt;
        charX = clamp(charX, minX, maxX);
        charImg.style.left = charX + "px";
      }
    }

    /**********************************************
     * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°ï¼†å½“ãŸã‚Šåˆ¤å®š
     **********************************************/
    function updateObjects(dt) {
      const toRemove = [];
      const charBounds = getCharBounds();
      const screenH = window.innerHeight;

      for (let i = 0; i < objects.length; i++) {
        const obj = objects[i];
        obj.y += obj.vy * dt;
        obj.el.style.top = obj.y + "px";

        const rect = obj.el.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        let collided = false;

        // ã‚­ãƒ£ãƒƒãƒåˆ¤å®šï¼ˆã‚«ã‚´ã®ç¯„å›²ï¼‰
        if (
          centerX >= charBounds.left &&
          centerX <= charBounds.right &&
          centerY >= charBounds.top &&
          centerY <= charBounds.bottom
        ) {
          collided = true;
        }

        if (collided) {
          // ã‚¹ã‚³ã‚¢å‡¦ç†
          if (obj.type === "normal") {
            score += SCORE_NORMAL;
            createPopup(centerX, centerY, `+${SCORE_NORMAL}`);
          } else if (obj.type === "gold") {
            score += SCORE_GOLD;
            createPopup(centerX, centerY, `+${SCORE_GOLD}`);
          } else if (obj.type === "leaf") {
            score += SCORE_LEAF;
            createPopup(centerX, centerY, `${SCORE_LEAF}`);
            // ãƒ“ãƒƒã‚¯ãƒªé¡”ï¼†ç¡¬ç›´
            if (!isStunned) {
              isStunned = true;
              charImg.src = IMG_CHAR_HIT;
              if (stunTimeoutId) clearTimeout(stunTimeoutId);
              stunTimeoutId = setTimeout(() => {
                isStunned = false;
                charImg.src = IMG_CHAR_NORMAL;
              }, STUN_DURATION);
            }
          }

          // ä½¿ã„çµ‚ã‚ã£ãŸã®ã§å‰Šé™¤å¯¾è±¡
          toRemove.push(i);
        } else if (obj.y > screenH + 100) {
          // ç”»é¢å¤–ã«è½ã¡ãŸã‚‰å‰Šé™¤
          toRemove.push(i);
        }
      }

      // å¾Œã‚ã‹ã‚‰å‰Šé™¤
      for (let i = toRemove.length - 1; i >= 0; i--) {
        const idx = toRemove[i];
        const obj = objects[idx];
        obj.el.remove();
        objects.splice(idx, 1);
      }
    }

    /**********************************************
     * ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
     **********************************************/
    function gameLoop(timestamp) {
      if (!gameStarted || gameOver) return;

      if (lastTime == null) {
        lastTime = timestamp;
        requestAnimationFrame(gameLoop);
        return;
      }

      const deltaMs = timestamp - lastTime;
      const dt = deltaMs / 1000;
      lastTime = timestamp;

      // æ™‚é–“æ›´æ–°
      remainingTime -= dt;
      if (remainingTime <= 0) {
        remainingTime = 0;
        updateHud();
        endGame();
        return;
      }

      // ç”Ÿæˆï¼†æ›´æ–°
      spawnObject(deltaMs);
      updateCharacter(dt);
      updateObjects(dt);
      updateHud();

      requestAnimationFrame(gameLoop);
    }

    /**********************************************
     * ã‚²ãƒ¼ãƒ é–‹å§‹ï¼çµ‚äº†
     **********************************************/
    function startGame() {
      if (gameStarted) return;
      gameStarted = true;
      remainingTime = GAME_TIME;
      score = 0;
      updateHud();

      // ã‚­ãƒ£ãƒ©åˆæœŸä½ç½®ï¼šä¸­å¤®
      const rect = charImg.getBoundingClientRect();
      const charWidth = rect.width || 200;
      const minX = 24 + charWidth / 2;
      const maxX = window.innerWidth - 24 - charWidth / 2;
      charX = (minX + maxX) / 2;
      charImg.style.left = charX + "px";

      lastTime = null;
      spawnTimer = 500; // æœ€åˆã®èŠ‹ã¯å°‘ã—é…ã‚Œã¦è½ã¡ã¦ãã‚‹
      requestAnimationFrame(gameLoop);
    }

    function endGame() {
      if (gameOver) return;
      gameOver = true;

      // è½ã¡ã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç‰‡ä»˜ã‘
      objects.forEach((obj) => obj.el.remove());
      objects.length = 0;

      const s = String(score).padStart(4, "0");
      resultScore.textContent = `score ${s}`;
      resultOverlay.style.display = "flex";
    }

    /**********************************************
     * å…¥åŠ›å‡¦ç†ï¼ˆå·¦å³ãƒœã‚¿ãƒ³ï¼‰
     **********************************************/
    function setMoveDir(dir) {
  if (isStunned) {
    moveDir = 0;
    return;
  }

  moveDir = dir;

  if (dir < 0) {
    // â† å·¦å‘ã
    charImg.classList.add("flipH");
  } else if (dir > 0) {
    // â†’ å³å‘ã
    charImg.classList.remove("flipH");
  }
}

    function setupButtonHold(btn, dir) {
      // ãƒã‚¦ã‚¹
      btn.addEventListener("mousedown", (e) => {
        e.preventDefault();
        setMoveDir(dir);
      });
      window.addEventListener("mouseup", () => {
        setMoveDir(0);
      });

      // ã‚¿ãƒƒãƒ
      btn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        setMoveDir(dir);
      }, { passive: false });

      ["touchend", "touchcancel"].forEach((ev) => {
        window.addEventListener(ev, () => {
          setMoveDir(0);
        });
      });
    }

    setupButtonHold(btnLeft, -1);
    setupButtonHold(btnRight, 1);

    /**********************************************
     * çµæœãƒœã‚¿ãƒ³
     **********************************************/
    btnRetry.addEventListener("click", () => {
      // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒªã‚»ãƒƒãƒˆ
      window.location.reload();
    });

    btnTitle.addEventListener("click", () => {
      // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¸æˆ»ã‚‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¯ãƒˆãƒŸãƒ¼å´ã®ã‚¿ã‚¤ãƒˆãƒ«htmlã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦OKï¼‰
      window.location.href = "index.html";
    });

    /**********************************************
     * èµ·å‹•
     **********************************************/
    window.addEventListener("load", () => {
      // èª­ã¿è¾¼ã¿å®Œäº†ã¨åŒæ™‚ã«ã‚²ãƒ¼ãƒ é–‹å§‹
      startGame();
    });
  </script>
</body>
</html>
